# ARCHITECTURE.md — Watch Together

> Generated by `/map` | Updated: 2026-02-21

## Overview

Watch Together is a real-time collaborative video watching application. Users can create or join rooms to watch local video files together, synchronized via WebRTC/WebTorrent P2P streaming, with real-time chat and a play queue.

---

## System Architecture

```
┌─────────────────────────────────────────────────────┐
│                   CLIENT (Browser)                  │
│                                                     │
│  React + Vite SPA                                   │
│  ┌────────────┐  ┌─────────────┐  ┌─────────────┐  │
│  │LandingPage │  │ RoomLayout  │  │ VideoPlayer │  │
│  └────────────┘  └─────────────┘  └─────────────┘  │
│  ┌──────────────┐  ┌───────────┐                    │
│  │UserQueueSide │  │  ChatUI   │                    │
│  └──────────────┘  └───────────┘                    │
│                                                     │
│  WebTorrent (P2P streaming via WebRTC)              │
│  Socket.io Client (signaling + sync)                │
└──────────────────────┬──────────────────────────────┘
                       │ HTTP + WebSocket
┌──────────────────────▼──────────────────────────────┐
│                 BACKEND (Node.js)                   │
│                                                     │
│  Express.js server                                  │
│  Socket.io server (room management, sync events)    │
│  BitTorrent Tracker (local WebTorrent tracker)      │
└─────────────────────────────────────────────────────┘
```

---

## Directory Structure

```
watch-together/
├── backend/
│   ├── server.js              # Express + Socket.io + BitTorrent Tracker
│   ├── package.json
│   └── .env.example
├── frontend/
│   ├── src/
│   │   ├── main.jsx           # React entry point
│   │   ├── App.jsx            # Router (LandingPage / RoomLayout)
│   │   ├── socket.js          # Socket.io client singleton
│   │   ├── torrentClient.js   # WebTorrent client singleton
│   │   ├── context/
│   │   │   └── RoomContext.jsx  # Global room + user state
│   │   └── components/
│   │       ├── LandingPage.jsx  # Create/Join room UI
│   │       ├── RoomLayout.jsx   # Room shell (video + sidebar)
│   │       ├── VideoPlayer.jsx  # Torrent streaming + player
│   │       ├── UserQueueSidebar.jsx  # User list + video queue
│   │       └── ChatUI.jsx       # Real-time chat
│   ├── vite.config.js
│   ├── tailwind.config.js
│   └── package.json
├── .gsd/                      # GSD project management
├── .agent/                    # GSD workflows and skills
└── .gemini/                   # Gemini-specific config
```

---

## Technology Stack

### Backend
| Tech | Version | Purpose |
|------|---------|---------|
| Node.js | LTS | Runtime |
| Express.js | ^5.2.1 | HTTP server |
| Socket.io | ^4.8.3 | Real-time signaling + room sync |
| bittorrent-tracker | ^11.2.2 | Local WebTorrent tracker |

### Frontend
| Tech | Version | Purpose |
|------|---------|---------|
| React | ^18 | UI framework |
| Vite | Latest | Build tool |
| TailwindCSS | Latest | Styling |
| WebTorrent | Latest | P2P video streaming |
| Socket.io-client | Latest | Real-time events |

---

## Core Data Flows

### Room Creation
```
LandingPage → POST /api/room/create → server.js → socket "room:created"
```

### P2P Video Streaming
```
Host: FileInput → WebTorrent.seed() → torrent magnet
    → emit("video:load", {magnet}) → Socket.io
Viewer: receive magnet → WebTorrent.add() → stream → <video>
```

### Playback Sync
```
Host action (play/pause/seek) → socket emit → server broadcast
    → all viewers receive → VideoPlayer syncs
```

### Chat
```
User types → socket.emit("chat:message") → server broadcast
    → ChatUI receives + displays
```

---

## Key Design Decisions

- **P2P First**: Uses WebTorrent so the host's file is streamed directly to viewers without server storage
- **Local Tracker**: Backend runs a BitTorrent tracker so P2P works even on localhost
- **Context API**: `RoomContext` manages all shared state (user, room, queue, chat)
- **Single Socket**: `socket.js` exports a singleton Socket.io client
